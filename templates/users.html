<!--
Synology Chat Push Gateway
Copyright 2024 leipeng1998

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>用户管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            padding: 40px;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        .container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        th {
            background-color: #0d6efd;
            color: white;
        }
        tr:hover {
            background-color: #f1f3f5;
        }
        form.add-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        form.add-form input {
            flex: 1;
        }
    </style>
</head>
<body>
<div class="container">
    <h3 class="text-center mb-4">用户管理系统</h3>

    <!-- 添加用户 -->
    <form class="add-form" method="POST" action="/add_user">
        <input type="text" name="username" class="form-control" placeholder="用户名" required>
        <input type="password" name="password" class="form-control" placeholder="密码" required>
{#        <input type="text" name="sid" class="form-control" placeholder="SID">#}
        <input type="text" name="gotify_url" class="form-control" placeholder="Gotify URL:http(s)://域名(:端口)/message">
        <input type="text" name="gotify_token" class="form-control" placeholder="Gotify Token">
        <button class="btn btn-primary" type="submit">添加</button>
    </form>

    <!-- 用户表格 -->
    <table class="table table-hover table-bordered text-center align-middle">
        <thead>
            <tr>
                {% for field in fields %}
                <th>{{ field }}</th>
                {% endfor %}
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for row in users %}
            <tr>
                {% for cell in row %}
                    {% if loop.index0 == 1 %}
                    <!-- 是否封禁列 -->
                    <td>
                        <button class="btn btn-sm {% if cell == 0 %}btn-success{% else %}btn-secondary{% endif %}"
                                onclick="toggleBan({{ row[0] }}, this)">
                            {% if cell == 0 %}已启用{% else %}已封禁{% endif %}
                        </button>
                    </td>

                    <script>
                    function toggleBan(userId, btn) {
                        fetch(`/toggle_ban_ajax/${userId}`, {
                            method: 'POST',
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // 更新按钮状态和颜色
                                if (data.new_status === 0) {
                                    btn.classList.remove('btn-secondary');
                                    btn.classList.add('btn-success');
                                    btn.innerText = '已启用';
                                } else {
                                    btn.classList.remove('btn-success');
                                    btn.classList.add('btn-secondary');
                                    btn.innerText = '已封禁';
                                }
                            } else {
                                alert('切换失败: ' + data.message);
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            alert('请求失败');
                        });
                    }
                    </script>
                    {% else %}
                    <td>{{ cell }}</td>
                    {% endif %}
                {% endfor %}
                <td>
                    <!-- 编辑按钮 -->
                    <button class="btn btn-warning btn-sm"
                            data-bs-toggle="modal"
                            data-bs-target="#editModal"
                            data-id="{{ row[0] }}"
                            data-username="{{ row[2] }}"
                            data-password="{{ row[3] }}"
{#                            data-sid="{{ row[4] }}"#}
                            data-gotify_url="{{ row[4] }}"
                            data-gotify_token="{{ row[5] }}">
                        编辑
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 编辑弹窗 -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="POST" id="editForm">
        <div class="modal-header">
          <h5 class="modal-title">编辑用户</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
            <!-- 用户名 -->
            <div class="mb-3">
                <label class="form-label">用户名</label>
                <input type="text" name="username" id="editUsername" class="form-control" placeholder="用户名" required>
            </div>

            <!-- 密码 -->
            <div class="mb-3">
                <label class="form-label">密码</label>
                <input type="password" name="password" id="editPassword" class="form-control" placeholder="密码" required>
            </div>

            <!-- Gotify URL -->
            <div class="mb-3">
                <label class="form-label">Gotify URL:http(s)://域名(:端口)/message</label>
                <input type="text" name="gotify_url" id="editGotifyUrl" class="form-control" placeholder="Gotify URL">
                <div class="form-text">Gotify 服务器地址:http(s)://域名(:端口)/message	A</div>
            </div>

            <!-- Gotify Token -->
            <div class="mb-3">
                <label class="form-label">Gotify Token</label>
                <input type="text" name="gotify_token" id="editGotifyToken" class="form-control" placeholder="Gotify Token">
                <div class="form-text">Gotify 访问令牌</div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">保存修改</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
    // 编辑弹窗填充数据
    const editModal = document.getElementById('editModal');
    editModal.addEventListener('show.bs.modal', event => {
        const button = event.relatedTarget;
        const id = button.getAttribute('data-id');
        document.getElementById('editForm').action = `/edit_user/${id}`;
        document.getElementById('editUsername').value = button.getAttribute('data-username');
        document.getElementById('editPassword').value = button.getAttribute('data-password');
        {#document.getElementById('editSid').value = button.getAttribute('data-sid');#}
        document.getElementById('editGotifyUrl').value = button.getAttribute('data-gotify_url');
        document.getElementById('editGotifyToken').value = button.getAttribute('data-gotify_token');
    });
</script>
</body>
</html>
